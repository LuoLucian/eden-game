<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç®¡ç†å‘˜æ§åˆ¶å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: gold;
      text-align: center;
    }
    .status {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .btn {
      padding: 12px 25px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .start { background: #4caf50; color: white; }
    .end { background: #f44336; color: white; }
    .reset { background: #ff9800; color: white; }
    .rollback { background: #2196f3; color: white; }
    .danger { background: #d32f2f; color: white; }
    .leaderboard {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘‘ ä¼Šç”¸å›­ Â· ç®¡ç†å‘˜æ§åˆ¶å°</h1>
    
    <div class="status">
      <p><strong>å½“å‰è½®æ¬¡ï¼š</strong>ç¬¬ {{ current_round }} è½®</p>
      <p><strong>æ¸¸æˆçŠ¶æ€ï¼š</strong>
        {% if game_ended %}
          ğŸ å·²ç»“æŸ
        {% elif round_status == 'waiting' %}
          â³ ç­‰å¾…å¼€å§‹
        {% elif round_status == 'voting' %}
          ğŸ—³ï¸ æŠ•ç¥¨ä¸­ï¼ˆå‰©ä½™ {{ remaining_time }} ç§’ï¼‰
        {% else %}
          âœ… ç»“ç®—å®Œæˆ
        {% endif %}
      </p>
      <p><strong>ç©å®¶æ€»æ•°ï¼š</strong>{{ total_players }} / {{ max_players }}</p>
      {% if round_status == 'voting' %}
        <p><strong>æœªæŠ•ç¥¨äººæ•°ï¼š</strong>{{ not_voted_count }}</p>
      {% endif %}
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div>
      {% if not game_ended and round_status == 'waiting' %}
        <button class="btn start" onclick="startRound()">â–¶ï¸ å¼€å§‹æœ¬è½®æŠ•ç¥¨</button>
      {% elif not game_ended and round_status == 'voting' %}
        <button class="btn end" onclick="endRound()">â¹ï¸ æ‰‹åŠ¨ç»“ç®—æœ¬è½®</button>
      {% endif %}
    </div>

    <!-- è°ƒè¯•ä¸é‡ç½® -->
    <div style="margin-top: 30px; padding: 15px; background: #222; border-radius: 8px;">
      <h3>ğŸ”§ è°ƒè¯•ä¸é‡ç½®</h3>
      
      <button onclick="resetCurrentRound()" class="btn reset">
        ğŸ”„ é‡ç½®æœ¬è½®ï¼ˆæ¸…ç©ºæŠ•ç¥¨ï¼‰
      </button>

      <button onclick="rollbackToPrevious()" class="btn rollback" 
              {% if current_round <= 1 %}disabled{% endif %}>
        âª å›é€€åˆ°ä¸Šä¸€è½®
      </button>

      <button onclick="resetAllData()" class="btn danger">
        ğŸ’¥ é‡ç½®å…¨éƒ¨æ•°æ®ï¼ˆæ…ç”¨ï¼ï¼‰
      </button>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="leaderboard">
      <h3>ğŸ† å®æ—¶æ’è¡Œæ¦œï¼ˆTop 15ï¼‰</h3>
      {% for p in top15 %}
        <div>#{{ p.id }}ï¼šÂ¥{{ p.balance }}</div>
      {% endfor %}
    </div>
  </div>

  <script>
    // âœ… å…³é”®ï¼šæ‰€æœ‰å¸ƒå°”å€¼å¿…é¡»ç”¨ | tojson é˜²æ­¢ JS æŠ¥é”™
    const gameEnded = {{ game_ended | tojson }};

    function startRound() {
      if (gameEnded) {
        alert('æ¸¸æˆå·²ç»“æŸï¼Œæ— æ³•å¼€å§‹æ–°è½®æ¬¡ã€‚');
        return;
      }
      fetch('/admin/start_round', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            location.reload(); // æ“ä½œæˆåŠŸååˆ·æ–°é¡µé¢
          } else {
            alert('âŒ ' + data.message);
          }
        })
        .catch(err => {
          console.error(err);
          alert('ç½‘ç»œé”™è¯¯');
        });
    }

    function endRound() {
      if (gameEnded) {
        alert('æ¸¸æˆå·²ç»“æŸã€‚');
        return;
      }
      if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨ç»“ç®—æœ¬è½®å—ï¼Ÿ')) return;
      fetch('/admin/end_round', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('âŒ ' + data.message);
          }
        })
        .catch(err => {
          console.error(err);
          alert('ç½‘ç»œé”™è¯¯');
        });
    }

    function resetCurrentRound() {
      if (!confirm('ç¡®å®šè¦é‡ç½®æœ¬è½®å—ï¼Ÿæ‰€æœ‰æœ¬è½®æŠ•ç¥¨å°†è¢«æ¸…ç©ºï¼Œä½†ç©å®¶ä½™é¢ä¿ç•™ã€‚')) return;
      fetch('/admin/reset_current_round', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          alert(data.message);
          location.reload();
        })
        .catch(err => {
          console.error(err);
          alert('æ“ä½œå¤±è´¥');
        });
    }

    function rollbackToPrevious() {
      if (!confirm('âš ï¸ ç¡®å®šè¦å›é€€åˆ°ä¸Šä¸€è½®å—ï¼Ÿå½“å‰è½®æ¬¡æ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼')) return;
      fetch('/admin/rollback_to_previous', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          alert(data.message);
          location.reload();
        })
        .catch(err => {
          console.error(err);
          alert('æ“ä½œå¤±è´¥');
        });
    }

    function resetAllData() {
      if (!confirm('ğŸ’¥ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ç©å®¶å’Œæ¸¸æˆè¿›åº¦ï¼\nç¡®å®šè¦å½»åº•é‡ç½®å—ï¼Ÿ')) return;
      fetch('/admin/reset_all', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          alert(data.message);
          location.reload();
        })
        .catch(err => {
          console.error(err);
          alert('æ“ä½œå¤±è´¥');
        });
    }
  </script>
</body>
</html>